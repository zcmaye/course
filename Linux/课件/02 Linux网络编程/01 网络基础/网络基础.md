## 计算机之间是如何通信的

### 原始时代

两台计算机之间如何通信呢？只需要给两台电脑连上一根网线就好了！

![image-20250824215416983](./assets/image-20250824215416983.png)

那么多台计算机如何通信呢？是不是把每台计算机用网线连接起来？

![image-20250824215534361](./assets/image-20250824215534361.png)

这样是可以的，但是这样成本太高，操作也不方便。于是我们把所有计算的的线拧在一起，这样也可以海鲜多台计算机值得相互通信！

### 集线器

这个拧在一起的线团就是集线器。

> 每台设备会有一张网卡，网卡会带着mac地址，这个就是该设备的标识。咱们再找一台计算机，给他多设计几个网口，我们每个人都连到这台计算机的网口上，不也实现咱们哥几个之间的互连了吗。
>
> 这个本身具备多个网口，专门实现多台计算机的互联作用的微型计算机就是集线器（HUB）。

顾名思义，集线器起到了一个将网线集结起来的作用，实现最初级的网络互通。集线器是通过网线直接传送数据的，我们说他工作在物理层。

![image-20250824215646525](./assets/image-20250824215646525.png)

集线器仅仅是将每台计算机的消息转发(广播)给所有人，不做其他任何处理。

由于转发到了所有出口，那 BCDE 四台机器怎么知道数据包是不是发给自己的呢？

**首先，**你要给所有的连接到集线器的设备，都起个名字。怎么取名呢？总不能叫ABCD吧！其实每台计算机都有一个网卡设备，而这个网卡设备在生产时，就已经在网卡(Network lnterface Card)的EPROM(一种闪存芯片，通常可以通过程序擦写)上烧录一个MAC地址！

> MAC地址也叫物理地址、硬件地址。

MAC地址由48位二进制数（6个字节）组成，通常表示为12位十六进制数 [9]，格式为XX-XX-XX-XX-XX-XX 。如：00-16-EA-AE-3C-40就是一个MAC地址，其中前3个字节，16进制数00-16-EA代表网络硬件制造商的编号，它由[IEEE](https://baike.baidu.com/item/IEEE/150905?fromModule=lemma_inlink)(电气与电子工程师协会)分配，而后3个字节，16进制数AE-3C-40代表该制造商所制造的某个网络产品(如网卡)的系列号。只要不更改自己的MAC地址，MAC地址在世界是唯一的。形象地说，MAC地址就如同身份证上的身份证号码，具有唯一性 。

**这样，**A 在发送数据包给 B 时，只要在头部拼接一个这样结构的数据，就可以了。

![image-20250824221748884](./assets/image-20250824221748884.png)

B 在收到数据包后，根据头部的目标 MAC 地址信息，判断这个数据包的确是发给自己的，于是便**收下**，不是发给自己的，于是便**丢弃**。

### 交换机

由于集线器广播的特点，在网络上数据量很大的情况下，会形成**广播风暴**。

> 网络上的广播帧由于被转发，数量急剧增加而出现无法正常网络通信的反常现象。广播风暴会占用相当可观的网络带宽，导致正常数据包无法正常运行。当广播数据充斥网络无法处理并占用大量网络带宽，导致正常业务不能运行，这就发生了广播风暴，造成局域网局部或整个网络瘫痪。

所以我们需要交换，来为接入交换机的任意两个网络节点提供独享的电信号通路。

> 网络节点是指一台电脑或其他设备与一个有独立地址和具有传送或接收数据功能的网络相连。比如：交换机、计算机、手机、平板、路由器等

![image-20250824222742876](./assets/image-20250824222742876.png)

**那么交换机是如何工作的呢？**

交换机内部维护一张 **MAC 地址表**，记录着每一个 MAC 地址的设备，连接在其哪一个端口上。

| MAC地址  | 端口  |
| -------- | ----- |
| BL:AC:K0 | 端口1 |
| GR:EE:NO | 端口3 |
| PU:RP:LE | 端口2 |
| OR:AN:GE | 端口4 |

此时当，**黑色**计算机想要给**橙色**计算机发送消息，需要在数据包中带上**源MAC地址**和**目标MAC地址**，并发送给交换机。

![image-20250824224247480](./assets/image-20250824224247480.png)

当交换机收到消息后，根据MAC地址表能直接找到目标MAC地址对应的端口，所以就直接把消息发送给**端口4**也就是橙色计算机。

随着机器数量越多，交换机的端口也不够了，但聪明的你发现，只要将多个交换机连接起来，这个问题就轻而易举搞定~

![image-20250824225644075](./assets/image-20250824225644075.png)

你完全不需要设计额外的东西，只需要按照之前的设计和规矩来，按照上述的接线方式即可完成所有电脑的互联，所以交换机设计的这种规则，真的很巧妙。

但是你要注意，上面那根蓝色的线，最终在 MAC 地址表中可不是一条记录呀，而是要把右边这三台机器与该端口的映射全部记录在表中。

最终，**两个交换机将分别记录这6台计算机和另外一个交换机的所有MAC映射记录**。

![image-20250824230325087](./assets/image-20250824230325087.png)

这在只有 6 台电脑的时候还好，甚至在只有几百台电脑的时候，都还好，所以这种交换机的设计方式，已经足足支撑一阵子了。

但很遗憾，人是贪婪的动物，很快，电脑的数量就发展到几千、几万、几十万。

### 路由器

交换机已经无法记录如此庞大的映射关系了。

此时你动了歪脑筋，你发现了问题的根本在于，连出去的那根红色的网线，后面不知道有多少个设备不断地连接进来，从而使得地址表越来越大。

那我可不可以让那根红色的网线，接入一个**新的设备**，这个设备就跟电脑一样有自己独立的 MAC 地址，而且同时还能帮我把数据包做一次**转发**呢？

这个设备就是路由器，**它的功能就是，作为一台独立的拥有 MAC 地址的设备，并且可以帮我把数据包做一次转发，你把它定在了网络层**

![image-20250824230835470](./assets/image-20250824230835470.png)

注意，路由器的每一个端口，都有独立的 MAC 地址

好了，现在交换机的 MAC 地址表中，只需要多出一条 路由器的MAC地址与其端口的映射关系，就可以成功把数据包转交给路由器了，这条搞定。

那现在如果**左边的黑色计算机**想要发送消息给**右边的黑色计算机**，如何实现的呢？

你会发现实现不了了，为啥？因为左边交换机中没有存储右边黑色电脑的MAC地址，从而当左边交换机收到黑色电脑发出的消息后，在MAC地址表中找不到对应的记录，所以将消息丢弃了！

那为什么交换机不把消息发送给路由器，然后让路由器继续转发，从而找到对方的MAC地址呢？

### IP地址

因为路由器是属于网络层的设备，他不能查找MAC地址，而是要使用另一种地址，**IP地址！**

> IP地址是互联网协议（Internet Protocol）为每台联网设备分配的唯一标识符，由一串数字（IPv4）或字母与数字组合（IPv6）构成。
>
> **IPv4（主流）：**32位二进制，通常写成四组十进制数，如 192.168.1.1。
>
> ​	示例：11000000.10101000.00000001.00000001 → 192.168.1.1
>
> **IPv6（下一代）：**128位，写成八组十六进制数，如 2001:0db8:85a3::8a2e:0370:7334。
>
> ​	特点：地址空间近乎无限，可满足物联网（IoT）的海量需求。

现在每一台电脑，同时有自己的 MAC 地址，又有自己的 IP 地址，只不过 IP 地址是**软件层面**上的，可以随时修改，MAC 地址一般是无法修改的。


![image-20250825002110629](./assets/image-20250825002110629.png)

**那么使用IP地址是如何通信的呢？**

现在两个设备之间传输，除了加上数据链路层的头部之外，还要再增加一个网络层的头部。

假如左边的黑色计算机要给左边的橙色计算机发消息，则发送的整个消息结构为:

![image-20250825131407019](./assets/image-20250825131407019.png)

假如左边的黑色计算机要给右边的橙色计算机发消息，则发送的整个消息结构为:

![image-20250825131643421](./assets/image-20250825131643421.png)

好了，上面说的两种情况，相信细心的读者应该会有不少疑问，下面我们一个个来展开。

### 子网掩码

对于计算机、服务器、手机、路由器等需要IP地址的设备，子网掩码是**至关重要**的。它的核心作用只有一个：**判断目标设备是否和自己在同一个局域网（子网）内。**

这个过程如下：

#### 获取目标IP：

当你的计算机（IP地址为192.168.0.1）想要将消息发送给另一台设备（192.168.0.2）时，它首先会拿出自己的子网掩码（225.225.225.0）和两个IP地址进行与运算。

192.168.0.1 & 225.225.225.0 = **192.168.0.0**

192.168.0.2 & 225.225.225.0 = **192.168.0.0**

这个通过与运算得出的结果就是网络号，网络号就是ip地址中的网络地址，用ip地址和子网掩码的二进制数进行“与”运算即可得出网络号。

#### 做出决策

+ 如果两个网络号（上面两个就是相同的），计算机就认为目标设备和自己在同一个子网。它会直接发送ARP广播请求，询问目标IP的MAC地址，然后封装数据帧，直接发送给目标设备。
+ 如果两个网络号不同，计算机就认为目标设备在另一个网络（比如互联网上的一个服务器）。它会将数据包发送给预先配置好的网关（通常就是路由器），由路由器来决定如何将数据包送达目的地。

**所以，对于计算机和路由器来说，子网掩码是定义网络边界、做出路由决策的根本依据。**

### 端口

现在两台计算机能相互之间通信了，那么计算机中有很多程序，那么怎么知道是哪个程序和哪个程序通信呢？

**端口（Port）** 就是为了解决这个问题而诞生的。它在IP地址的基础上，为电脑内部的每一个需要进行网络通信的**应用程序（或服务）** 分配一个唯一的数字标识。

> 因此，端口的“产生”是网络协议设计者为了实现**一台主机上的多个应用程序可以同时并行网络通信**而发明的机制。

端口号是一个16位的数字，范围是[0~65535]，这些端口又分为三种端口：

| 端口范围 | 类型 | 说明 |
| -------- | ---- | ---- |
|0~1023	|知名端口（Well-Known）|	分配给系统或核心服务（如HTTP:80、HTTPS:443、SSH:22），需管理员权限使用。|
|1024~49151	|注册端口（Registered）| 分配给用户级应用（如MySQL:3306、Redis:6379） |
|49152~65535|	动态/私有端口（Dynamic）|	临时分配给客户端程序（如浏览器访问网站时随机生成）。|

> [在线常用端口大全](https://www.bchrt.com/tools/common-ports/)

当消息到达操作系统后，会根据端口号把消息发给指定的进程！

## OSI模型

 开放式系统互联通信参考模型（英语：Open System Interconnection Reference Model，缩写：OSI；简称为OSI模型）是一种概念模型，由国际标准化组织提出，一个试图使各种计算机在世界范围内互连为网络的标准框架。

![无标题](./assets/无标题.png)



## 协议

[一文搞懂OSI参考模型与TCP/IP-阿里云开发者社区](https://developer.aliyun.com/article/1459877)







[(85 封私信 / 87 条消息) 有了 IP 地址，为什么还要用 MAC 地址？ - 知乎](https://www.zhihu.com/question/21546408)