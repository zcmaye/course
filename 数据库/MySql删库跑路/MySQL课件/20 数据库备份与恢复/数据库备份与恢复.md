# 数据库备份与恢复

在任何数据库环境中，总会有**不确定的意外**情况发生，比如例外的停电、计算机系统中的各种软硬件故障、人为破坏、管理员误操作等是不可避免的，这些情况可能会`导致数据的丢失`、`服务器瘫痪`等严重的后果。存在多个服务器时，会出现主从服务器之间的数据同步问题。

为了有效防止数据丢失，并将损失降到最低，应`定期`对MysQL数据库服务器做`备份`。如果数据库中的数据丢失或者出现错误，可以使用备份的`数据进行恢复`。主从服务器之间的数据同步问题可以通过复制功能实现。

## 1. 物理备份与逻辑备份

**物理备份**：备份数据文件，转储数据库物理文件到某一目录。物理备份恢复速度比较快，但占用空间比较大，MySQL中可以用 xtrabackup 工具来进行物理备份。

**逻辑备份**：对数据库对象利用工具进行导出工作，汇总入备份文件内。逻辑备份恢复速度慢，但占用空间小，更灵活。MySQL 中常用的逻辑备份工具为 mysqldump 。逻辑备份就是备份sql语句 ，在恢复的时候执行备份的sql语句实现数据库数据的重现。

### 逻辑备份(mysqldump)

`mysqldump` 是 MySQL 自带的逻辑备份工具，可将数据库结构与数据导出为 SQL 脚本，方便备份与恢复。它通过查询数据库并生成 `CREATE` 与 `INSERT` 语句来实现备份，恢复时直接执行这些语句即可还原数据。

假设目前MySQL中的数据库如下：

```sql
mysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| hdy                |
| hdy_master_slave   |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
6 rows in set (0.02 sec)
```

#### 备份所有数据库

若想用`mysqldump`备份整个实例，可以使用<font style="color:rgb(232,105,0)">`--all-databases`</font>或<font style="color:rgb(232,105,0)">`-A`</font>参数：

```bash
mysqldump -uroot -p --all-databases > backup/one/all.sql
```

> 说明： 备份的文件并非一定要求后缀名为.sql，例如后缀名为.txt的文件也是可以的。

备份文件内容很多，有几千行，就不在这里贴出了，我们可以通过如下命令查看到底备份了哪些数据库：

```bash
root@maye-vm-pc:~/backup/one# grep -i "Current Database" all.sql 
-- Current Database: `mysql`
-- Current Database: `hdy`
-- Current Database: `hdy_master_slave`
```

通过如下命令可以查看备份了哪些表：

```bash
root@maye-vm-pc:~/backup/one# grep -i "CREATE TABLE" all.sql | tail -n 7
CREATE TABLE IF NOT EXISTS `slow_log` (
CREATE TABLE `bonus` (
CREATE TABLE `dept` (
CREATE TABLE `emp` (
CREATE TABLE `salgrade` (
CREATE TABLE `emp` (
CREATE TABLE `t_emp` (
```

#### 备份指定数据库

语法如下：

```css
mysqldump –u 用户名称 –p密码 <db_name> > 备份文件名称.sql
```

比如要备份hdy数据库下面的所有数据：

```bash
mysqldump -uroot -p hdy > backup/one/hdy_bak.sql
```

备份文件内容如下：

```sql
-- MySQL dump 10.13  Distrib 8.4.7, for Linux (x86_64)
--
-- Host: localhost    Database: hdy
-- ------------------------------------------------------
-- Server version       8.4.7

-- 操作之前先保存一些变量，以便后续进行恢复
-- 40101 表明这些语句只有在mysql版本为4.01.01或者更高版本的条件下才可以执行
/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!50503 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `emp`
--

DROP TABLE IF EXISTS `emp`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `emp` (
  `empno` smallint NOT NULL,
  `ename` varchar(10) DEFAULT NULL,
  `job` varchar(9) DEFAULT NULL,
  `mgr` smallint DEFAULT NULL,
  `hiredate` date DEFAULT NULL,
  `sal` decimal(7,2) DEFAULT NULL,
  `comm` smallint DEFAULT NULL,
  `deptno` smallint DEFAULT NULL,
  PRIMARY KEY (`empno`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

-- 表' emp '转储的数据
--
-- Dumping data for table `emp`
--

-- 给emp表加写锁，防止别的会话写入数据，从而导致数据不一致问题
LOCK TABLES `emp` WRITE;
-- 告诉 MySQL 停止更新非唯一索引(因为更新索引会消耗大量的时间，禁用之后能提高速度)
/*!40000 ALTER TABLE `emp` DISABLE KEYS */;
INSERT INTO `emp` VALUES (7369,'SMITH','CLERK',7902,'2010-12-17',3800.00,NULL,20),(7499,'ALLEN','SALESMAN',7698,'2011-02-20',4600.00,300,30),(7521,'WARD','SALESMAN',7698,'2011-02-22',4250.00,500,30),(7566,'JONES','MANAGER',7839,'2011-04-02',6975.00,NULL,20),(7654,'MARTIN','SALESMAN',7698,'2011-09-28',4250.00,1400,30),(7698,'BLAKE','MANAGER',7839,'2011-05-01',5850.00,NULL,30),(7782,'CLARK','MANAGER',7839,'2011-06-09',5450.00,NULL,10),(7788,'SCOTT','ANALYST',7566,'2017-04-19',6000.00,NULL,20),(7839,'KING','PRESIDENT',NULL,'2011-11-17',8000.00,NULL,10),(7844,'TURNER','SALESMAN',7698,'2011-09-08',4500.00,0,30),(7876,'ADAMS','CLERK',7788,'2017-05-23',4100.00,NULL,20),(7900,'JAMES','CLERK',7698,'2011-12-03',3950.00,NULL,30),(7902,'FORD','ANALYST',7566,'2011-12-03',6000.00,NULL,20),(7934,'MILLER','CLERK',7782,'2012-01-23',4300.00,NULL,10),(8000,'maye','TEACHER',NULL,'2026-01-19',6000.00,NULL,40),(8001,'zc','TEACHER',8000,'2026-01-19',7000.00,NULL,40),(8002,'jack','TEACHER',8001,'2026-01-19',7300.00,NULL,40),(8003,'jerry','TEACHER',8002,'2026-01-19',7400.00,NULL,40);
/*!40000 ALTER TABLE `emp` ENABLE KEYS */;
UNLOCK TABLES;

-- 操作之后恢复变量
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;
/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
-- 存储完成的详细时间
-- Dump completed on 2026-01-23 14:55:38
```

#### 备份部分数据库

使用<font style="color:rgb(232,105,0)">`--databases`</font>或<font style="color:rgb(232,105,0)">`-B`</font>参数，该参数后面跟数据库名称，多个数据库间用空格隔开。语法如下：

```mysql
mysqldump –u user –h host –p --databases [数据库的名称1 [数据库的名称2...]] > 备份文件名称.sql
```

假设要备份`hdy`和`hdy_master_slave`数据库：

```mysql
mysqldump -uroot -p --databases hdy hdy_master_slave > part_db_back.sql
```

或

 ```mysql
mysqldump -uroot -p -B hdy hdy_master_slave > part_database.sql
 ```

#### 备份数据库的部分表

比如，在表变更前做个备份。语法如下：

 ```mysql
mysqldump –u user –h host –p 数据库的名称 [表名1 [表名2...]] > 备份文件名称.sql
 ```

比如要备份hdy数据库下的`emp`、`dept`表：

```mysql
mysqldump -uroot -p hdy emp dept > hdy_emp_dept_bak.sql
```

#### 排除指定的表

如果我们想备份某个库，但是某些表数据量很大或者与业务关联不大，这个时候可以通过`--ignore-table`选项直接排除掉。

比如备份hdy数据库，但是要排除掉`bouns`和`salgrade`表：

```bash
mysqldump -uroot -p hdy --ignore-table=hdy.bonus --ignore-table=hdy.salgrade > hdy_not_bouns_salgrade.sql
```

> `--ignore-table` 参数必须指定完整的数据库名和表名。

#### 按条件备份表的部分内容

有些时候一张表的数据量很大，我们只需要部分数据。这时就可以使用<font style="color:rgb(232,105,0)">`--where`</font>选项了，where后面附带需要满足的条件。

比如我们要备份`emp`表中薪资小于6000的数据：

```mysql
mysqldump -uroot -p hdy emp --where="sal < 6000 " > emp_part_sal_less_6000.sql
```

#### 只备份结构或只备份数据

只备份结构的话可以使用<font style="color:rgb(232,105,0)">`--no-data`</font>选项（简写为<font style="color:rgb(232,105,0)">`-d`</font>）。

只备份数据可以使用<font style="color:rgb(232,105,0)">`--no-create-info`</font>选项（简写为<font style="color:rgb(232,105,0)">`-t`</font>）

+ 只备份结构

```mysql
mysqldump -uroot -p hdy --no-data > hdy_no_data_bak.sql 
```

+ 只备份数据

```mysql
mysqldump -uroot -p hdy --no-create-info > hdy_no_create_info_bak.sql 
```

#### 备份包括存储过程、函数、事件

`mysqldump`备份默认是不包含存储过程，自定义函数及事件的。可以使用<font style="color:rgb(232,105,0)">`--routines`</font>或<font style="color:rgb(232,105,0)">`-R`</font>选项来备份存储过程及函数，使用<font style="color:rgb(232,105,0)">`--events`</font>或<font style="color:rgb(232,105,0)">`-E`</font>选项来备份事件。

比如，备份整个`hdy`库，包含存储过程及事件：

+ 先查看当前库有哪些存储过程或者函数

 ```mysql
mysql> SELECT SPECIFIC_NAME,ROUTINE_TYPE ,ROUTINE_SCHEMA FROM
information_schema.Routines WHERE ROUTINE_SCHEMA="hdy";
 ```

+ 如果没有随便创建两个

```sql
DELIMITER //
CREATE PROCEDURE proc_inc_sal(IN eno SMALLINT,IN esal DECIMAL(7,2))
COMMENT '给编号为eno的员工增加esal元薪资'
BEGIN
  UPDATE emp SET sal = sal + esal WHERE empno = eno;
END//
DELIMITER ;

DELIMITER //
CREATE FUNCTION fn_get_annual_salary(eno SMALLINT)
RETURNS DOUBLE
READS SQL DATA
COMMENT '获取编号为eno的员工的年薪'
BEGIN
    RETURN (SELECT 12 * sal FROM emp WHERE empno = eno);
END//
DELIMITER ;
```

+ 接下来开始备份包含存储过程和函数的创建语句。

```mysql
mysqldump -uroot -p -R -E --databases hdy > fn_hdy_bak.sql
```

#### mysqldump常用选项

mysqldump其他常用选项如下：

```mysql
--add-drop-database：在每个CREATE DATABASE语句前添加DROP DATABASE语句。

--add-drop-tables：在每个CREATE TABLE语句前添加DROP TABLE语句。

--add-locking：用LOCK TABLES和UNLOCK TABLES语句引用每个表转储。重载转储文件时插入得更快。

--all-database, -A：转储所有数据库中的所有表。与使用--database选项相同，在命令行中命名所有数据库。

--comment[=0|1]：如果设置为0，禁止转储文件中的其他信息，例如程序版本、服务器版本和主机。
--skip-comments与--comments=0的结果相同。默认值为1，即包括额外信息。

--compact：产生少量输出。该选项禁用注释并启用--skip-add-drop-tables、--no-set-names、--skip- disable-keys和--skip-add-locking选项。

--compatible=name：产生与其他数据库系统或旧的MySQL服务器更兼容的输出，值可以为ansi、MySQL323、MySQL40、postgresql、oracle、mssql、db2、maxdb、no_key_options、no_table_options或者no_field_options。

--complete_insert, -c：使用包括列名的完整的INSERT语句。

--debug[=debug_options], -#[debug_options]：写调试日志。
--delete，-D：导入文本文件前清空表。

--default-character-set=charset：使用charsets默认字符集。如果没有指定，就使用utf8。

--delete--master-logs：在主复制服务器上，完成转储操作后删除二进制日志。该选项自动启用-master- data。

--extended-insert，-e：使用包括几个VALUES列表的多行INSERT语法。这样使得转储文件更小，重载文件时可  以加速插入。

--flush-logs，-F：开始转储前刷新MySQL服务器日志文件。该选项要求RELOAD权限。

--force，-f：在表转储过程中，即使出现SQL错误也继续。

--lock-all-tables，-x：对所有数据库中的所有表加锁。在整体转储过程中通过全局锁定来实现。该选项自动关   闭--single-transaction和--lock-tables。

--lock-tables，-l：开始转储前锁定所有表。用READ   LOCAL锁定表以允许并行插入MyISAM表。对于事务表（例如InnoDB和BDB），--single-transaction是一个更好的选项，因为它根本不需要锁定表。

--no-create-db，-n：该选项禁用CREATE DATABASE /*!32312 IF NOT EXIST*/db_name语句，如果给出-
-database或--all-database选项，就包含到输出中。

--no-create-info，-t：只导出数据，而不添加CREATE TABLE语句。

--no-data，-d：不写表的任何行信息，只转储表的结构。

--opt：该选项是速记，它可以快速进行转储操作并产生一个能很快装入MySQL服务器的转储文件。该选项默认开启，   但可以用--skip-opt禁用。

--password[=password]，-p[password]：当连接服务器时使用的密码。

-port=port_num，-P port_num：用于连接的TCP/IP端口号。

--protocol={TCP|SOCKET|PIPE|MEMORY}：使用的连接协议。

--replace，-r –replace和--ignore：控制替换或复制唯一键值已有记录的输入记录的处理。如果指定-- replace，新行替换有相同的唯一键值的已有行；如果指定--ignore，复制已有的唯一键值的输入行被跳过。如果不   指定这两个选项，当发现一个复制键值时会出现一个错误，并且忽视文本文件的剩余部分。

--silent，-s：沉默模式。只有出现错误时才输出。

--socket=path，-S path：当连接localhost时使用的套接字文件（为默认主机）。

--user=user_name，-u user_name：当连接服务器时MySQL使用的用户名。

--verbose，-v：冗长模式，打印出程序操作的详细信息。

--xml，-X：产生XML输出。
```

运行帮助命令<font style="color:rgb(232,105,0)">`mysqldump --help`</font>  ，可以获得特定版本的完整选项列表。

> 提示 如果运行mysqldump没有--quick或--opt选项，mysqldump在转储结果前将整个结果集装入内存。如果转储大数据库可能会出现问题，该选项默认启用，但可以用--skip-opt禁用。如果使用最新版本的mysqldump程序备份数据，并用于恢复到比较旧版本的MySQL服务器中，则不要使用--opt  或-e选项。



### 恢复备份(mysql)

可以使用`mysql`命令对备份的文件进行恢复，基本语法如下：

```mysql
mysql –u root –p [dbname] < backup.sql
```

将之前练习中备份的`hdy_emp_dept_bak.sql`文件中的备份导入数据库中，命令如下：

如果备份文件中包含了创建数据库的语句，则恢复的时候不需要指定数据库名称，如下所示

```mysql
mysql -uroot -p < hdy_emp_dept_bak.sql
```

否则需要指定数据库名称，如下所示

```mysql
mysql -uroot -p hdy < hdy_emp_dept_bak.sql
```

也可以在msyql客户端中通过`SOURCE`命令来执行sql文件（必须是绝对路径）：

```sql
SOURCE /root/backup/one/hdy_emp_dept_bak.sql
```



## 2. 表的导出与导入

导出是指将 MySQL 数据表的数据复制到文本文件，常用于快速导出表数据到文本文件。

导入则是一个逆过程，用于将文本文件的数据，重新导入到表中。

### 2.1 表的导出

#### 1. SELECT…INTO OUTFILE语句

> 不会导出表头，只有数据！！！

在 MySQL 中，可以使用 SELECTI...INTO OUTFILE 语句将表的内容导出成一个文本文件。SELECT...INTO OUTFILE 语句基本格式如下:

```sql
SELECT 列名 FROM table_name [WHERE 语句] INTO OUTFILE '目标文件' [OPTIONS]
```

该语句用 SELECT 来查询所需要的数据，用 INTO OUTFILE 来导出数据。其中，`目标文件`用来指定将查询的记录导出到哪个文件。这里需要注意的是，目标文件不能是一个已经存在的文件。

[OPTIONS] 为可选参数选项，OPTIONS 部分的语法包括 FIELDS 和 LINES 子句，其常用的取值有：

- **FIELDS TERMINATED BY '字符串'：**设置字符串为字段之间的分隔符，可以为单个或多个字符，默认情况下为制表符‘\t’。
- **FIELDS [OPTIONALLY] ENCLOSED BY '字符'：**设置字符来括上 CHAR、VARCHAR 和 TEXT 等字符型字段。如果使用了 OPTIONALLY 则只能用来括上 CHAR 和 VARCHAR 等字符型字段。
- **FIELDS ESCAPED BY '字符'：**设置如何写入或读取特殊字符，只能为单个字符，即设置转义字符，默认值为‘\’。
- **LINES STARTING BY '字符串'：**设置每行开头的字符，可以为单个或多个字符，默认情况下不使用任何字符。
- **LINES TERMINATED BY '字符串'：**设置每行结尾的字符，可以为单个或多个字符，默认值为‘\n’ 。

注意：FIELDS 和 LINES 两个子句都是自选的，但是如果两个都被指定了，FIELDS 必须位于 LINES的前面。

##### 案例一：普通导出

使用`SELECT ... INTO OUTFILE`将hdy数据库中emp表导出到文本文件。 

```sql
SELECT * FROM hdy.emp INTO OUTFILE 'backup/two/emp_0.txt';
```

注意：有可能会出现如下错误：

```sql
ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement
```

大概意思是，MySQL导出只能导出到安全目录，也就是`secure_file_priv`变量所表示的目录：

```sql
mysql> SHOW VARIABLES LIKE 'secure_file%';
+------------------+-----------------------+
| Variable_name    | Value                 |
+------------------+-----------------------+
| secure_file_priv | /var/lib/mysql-files/ |
+------------------+-----------------------+
1 row in set (0.00 sec)
```

> 经过我的测试各种方法修改路径都不能导出！！！所以我们直接把文件导出到安全目录即可！

```sql
SELECT * FROM hdy.emp INTO OUTFILE '/var/lib/mysql-files/emp_0.txt';
```

查看emp_0.txt文件内容：

```bash
root@maye-vm-pc:/# cat /var/lib/mysql-files/emp_0.txt 
7369    SMITH   CLERK   7902    2010-12-17      3800.00 \N      20
7499    ALLEN   SALESMAN        7698    2011-02-20      4600.00 300     30
7521    WARD    SALESMAN        7698    2011-02-22      4250.00 500     30
7566    JONES   MANAGER 7839    2011-04-02      6975.00 \N      20
7654    MARTIN  SALESMAN        7698    2011-09-28      4250.00 1400    30
7698    BLAKE   MANAGER 7839    2011-05-01      5850.00 \N      30
7782    CLARK   MANAGER 7839    2011-06-09      5450.00 \N      10
7788    SCOTT   ANALYST 7566    2017-04-19      6000.00 \N      20
7839    KING    PRESIDENT       \N      2011-11-17      8000.00 \N      10
7844    TURNER  SALESMAN        7698    2011-09-08      4500.00 0       30
7876    ADAMS   CLERK   7788    2017-05-23      4100.00 \N      20
7900    JAMES   CLERK   7698    2011-12-03      3950.00 \N      30
7902    FORD    ANALYST 7566    2011-12-03      6000.00 \N      20
7934    MILLER  CLERK   7782    2012-01-23      4300.00 \N      10
8000    maye    TEACHER \N      2026-01-19      6000.00 \N      40
8001    zc      TEACHER 8000    2026-01-19      7000.00 \N      40
8002    jack    TEACHER 8001    2026-01-19      7300.00 \N      40
8003    jerry   TEACHER 8002    2026-01-19      7400.00 \N      40
```

##### 案例二：指定分隔符

如果想要导出的结果不使用空格分隔，而是使用自定义分隔符，可以使用如下语句：

```mysql
#字段值之间用逗号分隔，字符串字段用双引号包裹
SELECT * FROM hdy.emp INTO OUTFILE '/var/lib/mysql-files/emp_2.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"';
```

查看文件内容：

```bash
root@maye-vm-pc:/# cat /var/lib/mysql-files/emp_2.csv 
"7369","SMITH","CLERK","7902","2010-12-17","3800.00",\N,"20"
"7499","ALLEN","SALESMAN","7698","2011-02-20","4600.00","300","30"
"7521","WARD","SALESMAN","7698","2011-02-22","4250.00","500","30"
"7566","JONES","MANAGER","7839","2011-04-02","6975.00",\N,"20"
"7654","MARTIN","SALESMAN","7698","2011-09-28","4250.00","1400","30"
"7698","BLAKE","MANAGER","7839","2011-05-01","5850.00",\N,"30"
"7782","CLARK","MANAGER","7839","2011-06-09","5450.00",\N,"10"
"7788","SCOTT","ANALYST","7566","2017-04-19","6000.00",\N,"20"
"7839","KING","PRESIDENT",\N,"2011-11-17","8000.00",\N,"10"
"7844","TURNER","SALESMAN","7698","2011-09-08","4500.00","0","30"
"7876","ADAMS","CLERK","7788","2017-05-23","4100.00",\N,"20"
"7900","JAMES","CLERK","7698","2011-12-03","3950.00",\N,"30"
"7902","FORD","ANALYST","7566","2011-12-03","6000.00",\N,"20"
"7934","MILLER","CLERK","7782","2012-01-23","4300.00",\N,"10"
"8000","maye","TEACHER",\N,"2026-01-19","6000.00",\N,"40"
"8001","zc","TEACHER","8000","2026-01-19","7000.00",\N,"40"
"8002","jack","TEACHER","8001","2026-01-19","7300.00",\N,"40"
"8003","jerry","TEACHER","8002","2026-01-19","7400.00",\N,"40"
```



#### 2. mysqldump命令

> 不会导出表头，只有表数据！！！

mysqldump 是 MySQL 提供的用于备份和导出数据库的命令行工具。

##### 案例一：普通导出

使用mysqldump命令将将hdy数据库中emp表中的记录导出到`文本文件`(存储表数据)和`SQL文件`(存储创建表的语句)：

```mysql
mysqldump -uroot -p -T "/var/lib/mysql-files" hdy emp
```

mysqldump命令执行完毕后，在指定的目录`/var/lib/mysql-files`下生成了`emp.sql`和`emp.txt`文件。   

![image-20220723201627050](assets/image-20220723201627050.png)



##### 案例二：添加分隔符

使用mysqldump将hdy数据库中的emp表导出到文本文件，使用`FIELDS`选项，要求字段之间使用逗号(,)间隔，字符串类型字段值用双引号括起来：

```mysql
mysqldump -uroot -p -T "/var/lib/mysql-files" hdy emp --fields-terminated-by=, --fields-optionally-enclosed-by=\"
```

打开emp.txt文件，其内容包含emp表中的数据。从文件中可以看出，字段之间用逗号隔开，字符类型的值被双引号括起来。

```mysql
7369,"SMITH","CLERK",7902,"2010-12-17",3800.00,\N,20
7499,"ALLEN","SALESMAN",7698,"2011-02-20",4600.00,300,30
7521,"WARD","SALESMAN",7698,"2011-02-22",4250.00,500,30
7566,"JONES","MANAGER",7839,"2011-04-02",6975.00,\N,20
...
```

#### **3.** mysql命令

##### 案例一：导出普通文本文件

使用mysql语句导出test数据中emp表中的记录到文本文件(会同时导出表头)：

```mysql
mysql -uroot -p --execute="SELECT * FROM emp;" hdy > "/var/lib/mysql-files/emp_1.txt"
```

emp.txt

```css
empno	ename	job	mgr	hiredate	sal	comm	deptno
7499	ALLEN	SALESMAN	7698	1981-02-20	1600	300	30
7521	WARD	SALESMAN	7698	1981-02-22	1250	500	30
7566	JONES	MANAGER	7839	1981-04-02	2975	NULL	20
...
```

##### 案例二：数据多行显示

将test数据库emp表中的记录导出到文本文件，使用--veritcal参数将该条件记录分为多行  显示：

```mysql
mysql -uroot -p --vertical --execute="SELECT * FROM emp;" hdy > "/var/lib/mysql-files/emp_11.txt"
```

emp_1.txt

```css
*************************** 1. row ***************************
   empno: 7499
   ename: ALLEN
     job: SALESMAN
     mgr: 7698
hiredate: 1981-02-20
     sal: 1600
    comm: 300
  deptno: 30
*************************** 2. row ***************************
   empno: 7521
   ename: WARD
     job: SALESMAN
     mgr: 7698
hiredate: 1981-02-22
     sal: 1250
    comm: 500
  deptno: 30
```

##### 案例三：导出为xml文件

将hdy数据库emp表中的记录导出到xml文件，使用--xml参数，具体语句如下。

```mysql
mysql -uroot -p --xml --execute="SELECT * FROM emp" hdy > "/var/lib/mysql-files/emp.xml"
```

emp.xml

```xml
  <row>
	<field name="empno">7499</field>
	<field name="ename">ALLEN</field>
	<field name="job">SALESMAN</field>
	<field name="mgr">7698</field>
	<field name="hiredate">1981-02-20</field>
	<field name="sal">1600</field>
	<field name="comm">300</field>
	<field name="deptno">30</field>
  </row>
```

说明：如果要将表数据导出到html文件中，可以使用`--html` 选项。然后可以使用浏览器打开。

### 2.2 表的导入

#### 1. LOAD DATA INFILE语句

**举例**1：使用SELECT...INTO OUTFILE将test数据库中emp表的记录导出到文本文件

 ```mysql
SELECT * FROM hdy.emp INTO OUTFILE '/var/lib/mysql-files/emp_2.txt'; 
 ```

删除account表中的数据：

 ```mysql
DELETE FROM hdy.emp;
 ```

从文本文件emp_1.txt中恢复数据：

 ```mysql
LOAD DATA INFILE '/var/lib/mysql-files/emp_2.txt' INTO TABLE hdy.emp;
 ```



**举例**2：选择数据库hdy，使用SELECT…INTO OUTFILE将test数据库emp表中的记录导出到文本文件，使用FIELDS选项和LINES选项，要求字段之间使用逗号"，"间隔，所有字段值用双引号括起来：

```mysql
SELECT * FROM hdy.emp INTO OUTFILE '/var/lib/mysql-files/emp_2.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"';
```

删除account表中的数据：

```mysql
DELETE FROM hdy.emp;
```

从`'/var/lib/mysql-files/emp_2.csv'`中导入数据到account表中：

```mysql
LOAD DATA INFILE /var/lib/mysql-files/emp_2.csv' INTO TABLE test.emp FIELDS TERMINATED BY ',' ENCLOSED BY '\"';
```



#### 2. mysqlimport命令

> 文件名必须是表名

**举例：**导出文件emp.txt，字段之间使用逗号"，"间隔，字符串字段值用双引号括起来：

```mysql
SELECT * FROM hdy.emp INTO OUTFILE '/var/lib/mysql-files/emp.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"';
```

删除emp表中的数据：

```mysql
DELETE FROM hdy.emp;
```

使用mysqlimport命令将emp.txt文件内容导入到数据库test的emp表中：

```mysql
#这个文件名称必须和表明一致(emp.csv  文件名emp就是要导入的表名)
mysqlimport -uroot -p --local hdy "/var/lib/mysql-files/emp.csv" --fields-terminated-by=, --fields-optionally-enclosed-by=\"
```

查询account表中的数据：

```mysql
select * from account; 
mysql> select * from account;
+----+--------+---------+
| id | name	| balance |
+----+--------+---------+
|	1 | 张三	|	90 |
|	2 | 李四	|	100 |
|	3 | 王五	|	0 |
+----+--------+---------+
3 rows in set (0.00 sec)
```

##### 错误及解决方案

+ 错误1：mysql会默认在服务器上加载文件，但是我们的文件确是在本地，所以必须指定参数`--local`

  ```mysql
  mysqlimport -uroot -p --local test  '/var/lib/mysql-files/emp.txt'		#正确
  mysqlimport -uroot -p  test  '/var/lib/mysql-files/emp.txt'				#错误
  
  #mysqlimport: Error: 29, File 'E:\Tool\mysql-8.0.22-winx64\data\'C:\Users\Maye\backup\emp.txt'' not found (OS errno 2 - No such file or directory), when using table: emp
  ```

+ 错误2：加载本地数据被禁用；这必须在客户端和服务器端都启用才能使用`--local`

  ```mysql
  #如果执行一下命令出现错误，则必须先启用全局变量local_infile
  mysqlimport -uroot -p --local test  '/var/lib/mysql-files/emp.txt'	
  
  #mysqlimport: Error: 3948, Loading local data is disabled; this must be enabled on both the client and server sides, when using table: emp
  ```

  + 启用`local_infile`全局变量

    ```mysql
    SET @@global.local_infile = ON;
    #或
    SET GLOBAL local_infile = ON;
    ```

    

+ 错误3：mysqlimport命令的路径不能用单引号包裹，只能用双引号或者不加引号

  ```mysql
  mysqlimport -uroot -p --local test  '/var/lib/mysql-files/emp.txt'		#错误
  mysqlimport -uroot -p --local test  "/var/lib/mysql-files/emp.txt"		#正确
  mysqlimport -uroot -p --local test  /var/lib/mysql-files/emp.txt		#正确
  
  #mysqlimport: Error: 2, File ''/var/lib/mysql-files/emp.txt'' not found (OS errno 2 - No such file or directory), when using table: emp
  ```

  

## 3. 数据库迁移

### **3.1** **概述**

数据迁移（data  migration）是指选择、准备、提取和转换数据，并**将数据从一个计算机存储系统永久地传输到另一个计算机存储系统的过程**。此外，  <font style="color:rgb(232,105,0)">`验证迁移数据的完整性`</font>和 <font style="color:rgb(232,105,0)">`退役原来旧的数据存储`</font> ，也被认为是整个数据迁移过程的一部分。

数据库迁移的原因是多样的，包括服务器或存储设备更换、维护或升级，应用程序迁移，网站集成，灾难恢复和数据中心迁移。

根据不同的需求可能要采取不同的迁移方案，但总体来讲，MySQL 数据迁移方案大致可以分为 <font style="color:rgb(232,105,0)">`物理迁移`</font>和 <font style="color:rgb(232,105,0)">`逻辑迁移`</font>两类。通常以尽可能 <font style="color:rgb(232,105,0)">`自动化`</font>的方式执行，从而将人力资源从繁琐的任务中解放出来。

### 3.2 迁移方案

+ 物理迁移

物理迁移适用于大数据量下的整体迁移。使用物理迁移方案的优点是比较快速，但需要停机迁移并且要  求 MySQL 版本及配置必须和原服务器相同，也可能引起未知问题。

物理迁移包括拷贝数据文件和使用 XtraBackup 备份工具两种。

不同服务器之间可以采用物理迁移，我们可以在新的服务器上安装好同版本的数据库软件，创建好相同目录，建议配置文件也要和原数据库相同，然后从原数据库方拷贝来数据文件及日志文件，配置好文件组权限，之后在新服务器这边使用 mysqld 命令启动数据库。

+ 逻辑迁移

逻辑迁移适用范围更广，无论是<font style="color:rgb(232,105,0)">`部分迁移 `</font>还是<font style="color:rgb(232,105,0)">`全量迁移 `</font>，都可以使用逻辑迁移。逻辑迁移中使用最多的就是通过 mysqldump 等备份工具。

### 3.3 迁移注意点

**1.** **相同版本的数据库之间迁移注意点**

> 指的是在主版本号相同的MySQL数据库之间进行数据库移动。

<font style="color:rgb(232,105,0)">`方式1：`</font> 因为迁移前后MySQL数据库的主版本号相同 ，所以可以通过复制数据库目录来实现数据库迁移，但是物理迁移方式只适用于MyISAM引擎的表。对于InnoDB表，不能用直接复制文件的方式备份数据库。

<font style="color:rgb(232,105,0)">`方式2： `</font> 最常见和最安全的方式是使用 mysqldump命令导出数据，然后在目标数据库服务器中使用MySQL命令导入。

举例：

```mysql
#host1的机器中备份所有数据库,并将数据库迁移到名为host2的机器上
mysqldump –h host1 –uroot –p –-all-databases| mysql –h host2 –uroot –p
```

在上述语句中，“|”符号表示管道，其作用是将mysqldump备份的文件给mysql命令；“--all-databases”表   示要迁移所有的数据库。通过这种方式可以直接实现迁移。

**2.** **不同版本的数据库之间迁移注意点**

例如，原来很多服务器使用5.7版本的MySQL数据库，在8.0版本推出来以后，改进了5.7版本的很多缺陷，  因此需要把数据库升级到8.0版本

旧版本与新版本的MySQL可能使用不同的默认字符集，例如有的旧版本中使用latin1作为默认字符集，而最新版本的MySQL默认字符集为utf8mb4。如果数据库中有中文数据，那么迁移过程中需要对<font style="color:rgb(232,105,0)">`默认字符集`</font>进行修改 ，不然可能无法正常显示数据。

高版本的MySQL数据库通常都会 兼容低版本 ，因此可以从低版本的MySQL数据库迁移到高版本的MySQL 数据库。

**3.** **不同数据库之间迁移注意点**

不同数据库之间迁移是指从其他类型的数据库迁移到MySQL数据库，或者从MySQL数据库迁移到其他类  型的数据库。这种迁移没有普适的解决方法。

迁移之前，需要了解不同数据库的架构， 比较它们之间的差异 。不同数据库中定义相同类型的数据的关键字可能会不同。例如，MySQL中日期字段分为DATE和TIME两种，而ORACLE日期字段只有DATE；SQL Server数据库中有ntext、Image等数据类型，MySQL数据库没有这些数据类型；MySQL支持的ENUM和SET类型，这些SQL Server数据库不支持。

另外，数据库厂商并没有完全按照SQL标准来设计数据库系统，导致不同的数据库系统的<font style="color:rgb(232,105,0)">` SQL语句 `</font>有差别。例如，微软的SQL Server软件使用的是T-SQL语句，T-SQL中包含了非标准的SQL语句，不能和MySQL 的SQL语句兼容。

不同类型数据库之间的差异造成了互相<font style="color:rgb(232,105,0)">`迁移的困难 `</font>  ，这些差异其实是商业公司故意造成的技术壁垒。但是不同类型的数据库之间的迁移并不是完全不可能 。例如，可以使用<font style="color:rgb(232,105,0)">`MyODBC `</font>  实现MySQL和SQL Server之间的迁移。

MySQL官方提供的工具<font style="color:rgb(232,105,0)">` MySQL Migration Toolkit  `</font>也可以在不同数据库之间进行数据迁移。MySQL迁移到Oracle时，需要使用mysqldump命令导出sql文件，然后，手动更改sql文件中的CREATE语句。

### 3.4 迁移小结



![img](assets/wps142.jpg) 

 

## 4. 删库了不敢跑，能干点啥？

### 4.1 delete：误删行

**经验之谈：**

1. 恢复数据比较安全的做法，是<font style="color:rgb(232,105,0)">`恢复出一个备份`</font>，或者找一个从库作为<font style="color:rgb(232,105,0)">`临时库 `</font>，在这个临时库上执行这些操作，然后再讲确认过的临时库的数据，恢复回主库。如果直接修改主库，可能导致对数据库的<font style="color:rgb(232,105,0)">`二次破坏 `</font>

2. 当然，针对预防误删数据的问题，建议如下：
   1. 把 sql_safe_updates 参数设置为 on 。这样一来，如果我们忘记在delete或者update语句中写where条件，或者where条件里面没有包含索引字段的话，这条语句的执行就会报错。

      > 如果确定要把一个小表的数据全部删掉，在设置了sql_safe_updates=on情况下，可以  在delete语句中加上where条件，比如where id>=0。

   2.  代码上线前，必须经过 SQL审计 。

### 4.2 truncate/drop：误删库表

**方案：**

这种情况下，要想恢复数据，就需要使用<font style="color:rgb(232,105,0)">`全量备份  `</font> ，加<font style="color:rgb(232,105,0)">`增量日志  `</font> 的方式了。这个方案要求线上有定期的全量备份，并且实时备份binlog。

在这两个条件都具备的情况下，假如有人中午12点误删了一个库，恢复数据的流程如下：

1. 取最近一次 全量备份 ，假设这个库是一天一备，上次备份是当天 凌晨2点 ；

2. 用备份恢复出一个临时库 ；

3. 从日志备份里面，取出凌晨2点之后的日志；

4. 把这些日志，除了误删除数据的语句外，全部应用到临时库。



### 4.3 延迟复制备库

如果有<font style="color:rgb(232,105,0)">`非常核心的业务  `</font>，不允许太长的恢复时间，可以考虑**搭建延迟复制的备库。**一般的主备复制结构存在的问题是，如果主库上有个表被误删了，这个命令很快也会被发给所有从库，进而导致所有从库的  数据表也都一起被误删了。

延迟复制的备库是一种特殊的备库，通过  `CHANGE REPLICATION SOURCE TO SOURCE_DELAY = N` 命令，可以指定这个备库持续保持跟主库有<font style="color:rgb(232,105,0)">`N秒的延迟  `</font>。比如你把N设置为3600，这就代表了如果主库上有数据被误删了，并且在1小时内发现了这个误操作命令，这个命令就还没有在这个延迟复制的备库执行。这时候到这个备库上执行`STOP REPLICA`，再通过之前介绍的方法，跳过误操作命令，就可以恢复出需要的数据。

### 4.4 预防误删库/表的方法

1. 账号分离 。这样做的目的是，避免写错命令。比如：
   + 只给业务开发同学DML权限，而不给truncate/drop权限。而如果业务开发人员有DDL需求的话，可以通过开发管理系统得到支持。

   + 即使是DBA团队成员，日常也都规定只使用只读账号 ，必要的时候才使用有更新权限的账号。

2. 制定操作规范 。比如：
   		+ 在删除数据表之前，必须先对表做改名操作。然后，观察一段时间，确保对业务无影响以后再删除这张表。
      		+ 改表名的时候，要求给表名加固定的后缀（比如加 _to_be_deleted )，然后删除表的动作必须通过管理系统执行。并且，管理系统删除表的时候，只能删除固定后缀的表。

### 4.5 rm：误删MySQL实例

对于一个有高可用机制的MySQL集群来说，不用担心<font style="color:rgb(232,105,0)">`rm删除数据   `</font> 了。只是删掉了其中某一个节点的数据的话，HA系统就会开始工作，选出一个新的主库，从而保证整个集群的正常工作。我们要做的就是在这个节点上把数据恢复回来，再接入整个集群。

 

##  附录：MySQL常用命令

### 1 mysql

该mysql不是指mysql服务，而是指mysql的客户端工具。 

语法 ：

```mysql
mysql [options] [database]
```

#### 1. 连接选项

```mysql
#参数 ：
-u, --user=name	指定用户名
-p, --password[=name]	指定密码
-h, --host=name	指定服务器IP或域名
-P, --port=#	指定连接端口

#示例 ：
mysql -h 127.0.0.1 -P 3306 -u root -p mysql -h127.0.0.1 -P3306 -uroot -p密码
```

#### 2. 执行选项

```mysql
-e, --execute=name	执行SQL语句并退出
```

此选项可以在Mysql客户端执行SQL语句，而不用连接到MySQL数据库再执行，对于一些批处理脚本，这  种方式尤其方便。

```mysql
#示例：
mysql -uroot -p db01 -e "select * from tb_book";
```

![img](assets/wps174.jpg) 

### 2 mysqladmin

mysqladmin  是一个执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等。

可以通过 ： mysqladmin --help 指令查看帮助文档

![img](assets/wps175.jpg)

```mysql
#示例 ：
mysqladmin -uroot -p create 'test01'; 
mysqladmin -uroot -p drop 'test01'; 
mysqladmin -uroot -p version;
```

### 3 mysqlbinlog

由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到mysqlbinlog 日志管理工具。

语法 ：

```mysql
mysqlbinlog [options] log-files1 log-files2 ...

#选项：

-d, --database=name : 指定数据库名称，只列出指定的数据库相关操作。

-o, --offset=# : 忽略掉日志中的前n行命令。

-r,--result-file=name : 将输出的文本格式日志输出到指定文件。

-s, --short-form : 显示简单格式， 省略掉一些信息。

--start-datatime=date1 --stop-datetime=date2 : 指定日期间隔内的所有日志。

--start-position=pos1 --stop-position=pos2 : 指定位置间隔内的所有日志。 
```

### 4 mysqldump

mysqldump  客户端工具用来备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SQL语句。

语法 ： 

```mysql
mysqldump [options] db_name [tables]
mysqldump [options] --database/-B db1 [db2 db3...] 
mysqldump [options] --all-databases/-A
```

#### 1. 连接选项

 ```mysql
#参数 ：
-u, --user=name	指定用户名
-p, --password[=name]	指定密码
-h, --host=name	指定服务器IP或域名
-P, --port=#	指定连接端口
 ```

#### 2. 输出内容选项

```mysql
#参数：
--add-drop-database		#在每个数据库创建语句前加上 Drop database 语句
--add-drop-table 		#在每个表创建语句前加上 Drop table 语句 , 默认开启 ; 不开启 (--skip-add-drop-table)

-n, --no-create-db		#不包含数据库的创建语句
-t, --no-create-info	#不包含数据表的创建语句
-d --no-data			#不包含数据

-T, --tab=name			#自动生成两个文件：一个.sql文件，创建表结构的语句；一个.txt文件，数据文件，相当于select into outfile
```

 ```mysql
#示例 ：
mysqldump -uroot -p db01 tb_book --add-drop-database --add-drop-table > a

mysqldump -uroot -p -T /tmp test city
 ```

![image-20220714212222131](assets/image-20220714212222131.png)



### 5 mysqlimport/source

mysqlimport 是客户端数据导入工具，用来导入mysqldump 加 -T 参数后导出的文本文件。

语法：

```mysql
mysqlimport [options] db_name textfile1 [textfile2...]
```

示例：

 ```mysql
mysqlimport -uroot -p test /tmp/city.txt
 ```

如果需要导入sql文件,可以使用mysql中的source 指令 :

```mysql
source /root/tb_book.sql
```

 

### 6 mysqlshow

mysqlshow  客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。

语法：

```mysql
mysqlshow [options] [db_name [table_name [col_name]]]
```

参数：

```mysql
--count #显示数据库及表的统计信息（数据库，表 均可以不指定）
-i		#显示指定数据库或者指定表的状态信息
```

示例：

```mysql
#查询每个数据库的表的数量及表中记录的数量
[root@node1 Maye]> mysqlshow -uroot -p --count

#查询test库中每个表中的字段书，及行数
[root@node1 Maye]> mysqlshow -uroot -p atguigu --count

#查询test库中book表的详细情况
[root@node1 Maye]> mysqlshow -uroot -p atguigu book --count
```



